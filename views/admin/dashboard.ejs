<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Panel administrador</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/Assets/styles.css">
    <style>
      /* ====== CARDS ====== */
      .cards_admin {
        display: grid;
        grid-template-columns: repeat(4, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1.25rem;
      }
      .card_admin {
        background: #fff;
        border-radius: 1rem;
        padding: 1rem 1rem .8rem;
        box-shadow: 0 10px 25px rgba(15,23,42,.04);
      }
      .card_admin h2 {
        margin: 0 0 .25rem;
        font-size: 1.45rem;
      }
      .card_admin p {
        margin: 0;
        font-size: .8rem;
        color: #64748b;
      }

      .panel {
        background: #fff;
        border-radius: 1rem;
        padding: 1rem;
        box-shadow: 0 10px 25px rgba(15,23,42,.02);
      }
      .panel__header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: .6rem;
      }
      .movements-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: .5rem;
      }
      .movement-item {
        background: #f8fafc;
        border-radius: .6rem;
        padding: .45rem .6rem;
      }
      .movement-meta {
        font-size: .72rem;
        color: #64748b;
      }

      /* ====== LAYOUT BASE ====== */
      .admin-layout {
        display: flex;
        min-height: 100vh;
        background: #f1f5f9;
      }

      /* ====== SIDEBAR PROTEGIDA POR ID ====== */
      #adminSidebar {
        background: #0f172a;
        color: #fff;
        padding: 1rem 1.25rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        min-width: 230px;
      }
      #adminSidebar .admin-sidebar__brand {
        display: flex;
        gap: .5rem;
        align-items: center;
        font-weight: 600;
      }
      /* esto es el men√∫ en desktop */
      #adminSidebarNav {
        display: flex;
        flex-direction: column;
        gap: .4rem;
      }
      #adminSidebarNav .admin-sidebar__link {
        color: #e2e8f0;
        text-decoration: none;
        padding: .4rem .6rem;
        border-radius: .35rem;
      }
      #adminSidebarNav .admin-sidebar__link--active {
        background: rgba(255,255,255,.1);
      }

      .main {
        flex: 1;
        padding: 1.5rem;
      }

      /* bot√≥n hamburguesa oculto en desktop */
      #adminSidebarToggle {
        display: none;
      }

      @media (max-width: 900px) {
        .admin-layout {
          flex-direction: column;
        }

        #adminSidebar {
          width: 100%;
          flex-direction: row;
          align-items: center;
          justify-content: space-between;
          position: relative;
        }

        #adminSidebarToggle {
          display: inline-block;
          background: none;
          border: 1px solid rgba(255,255,255,.3);
          color: #fff;
          border-radius: .4rem;
          padding: .25rem .5rem;
          font-size: .9rem;
        }

        /* aqu√≠ lo escondemos en mobile S√ç o S√ç */
        #adminSidebarNav {
          display: none;
          flex-direction: column;
          gap: .5rem;
          background: #0f172a;
          width: 100%;
          position: absolute;
          top: 100%;
          left: 0;
          padding: .6rem .75rem .75rem;
          border-bottom-left-radius: .75rem;
          border-bottom-right-radius: .75rem;
          box-shadow: 0 10px 25px rgba(15,23,42,.25);
          z-index: 999; /* por si hay algo encima */
        }

        /* cuando el ASIDE tenga is-open, mostramos el nav */
        #adminSidebar.is-open #adminSidebarNav {
          display: flex !important;
        }

        .main {
          padding: 1rem;
        }
        .cards_admin {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>

  <body class="admin-layout">
    <!-- Sidebar -->
    <aside id="adminSidebar">
      <div class="admin-sidebar__brand">
        <span class="admin-sidebar__icon">üöó</span>
        <span class="admin-sidebar__title">Auto Dealer</span>
      </div>
      <button id="adminSidebarToggle" type="button">‚ò∞</button>
      <nav id="adminSidebarNav">
        <a href="/admin/dashboard" class="admin-sidebar__link admin-sidebar__link--active">Dashboard</a>
        <a href="/autos" class="admin-sidebar__link">Inventario</a>
        <a href="/admin/ventas" class="admin-sidebar__link">Ventas / Reservas</a>
        <a href="/admin/autos/nuevo" class="admin-sidebar__link">Publicar auto</a>
        <a href="/" class="admin-sidebar__link" target="_blank">Ver sitio</a>
      </nav>
    </aside>

    <!-- Contenido -->
    <main class="main">
      <header class="main__header" style="display:flex;justify-content:space-between;align-items:center;gap:1rem;">
        <h1 class="main__title">Dashboard</h1>
        <a href="/admin/autos/nuevo" class="btn btn--primary">+ Nuevo auto</a>
      </header>

      <section class="cards_admin">
        <article class="card_admin">
          <h2 class="card__number"><%= publicados %></h2>
          <p class="card__label">Autos publicados</p>
        </article>
        <article class="card_admin">
          <h2 class="card__number"><%= reservasMes %></h2>
          <p class="card__label">Reservas este mes</p>
        </article>
        <article class="card_admin">
          <h2 class="card__number"><%= reservados %></h2>
          <p class="card__label">Reservas activas</p>
        </article>
        <article class="card_admin">
          <h2 class="card__number">$<%= Number(ingresos || 0).toLocaleString('es-MX') %></h2>
          <p class="card__label">Ingresos por reservas (mes)</p>
        </article>
      </section>

      <section class="panel">
        <div class="panel__header">
          <h2>Movimientos recientes</h2>
          <a href="/admin/ventas" class="btn btn--primary" style="background:#e11d48;">Ver todas</a>
        </div>
        <% if (!movimientos || movimientos.length === 0) { %>
          <p class="empty">No hay reservas recientes.</p>
        <% } else { %>
          <ul class="movements-list">
            <% movimientos.forEach(m => { %>
              <li class="movement-item">
                <strong>Reserva #<%= m.id %></strong> ‚Äî <%= m.brand %> <%= m.model %> ‚Äî
                <span class="movement-meta">
                  del <%= m.start_date %> al <%= m.end_date %>
                  ¬∑ <%= m.user_name %>
                  ¬∑ $<%= Number(m.total_amount || 0).toLocaleString('es-MX') %>
                  ¬∑ <em><%= m.status %></em>
                </span>
              </li>
            <% }) %>
          </ul>
        <% } %>
      </section>

<%
  // declarar una sola vez si no lo tienes ya
  function fechaBonita(d) {
    if (!d) return "";
    let iso;
    if (d.toISOString) {
      iso = d.toISOString().slice(0,10);
    } else {
      iso = d.toString().slice(0,10);
    }
    const [y,m,day] = iso.split("-");
    const meses = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
    return Number(day) + " de " + meses[Number(m)-1] + " de " + y;
  }
%>

<section class="panel" style="margin-top:1rem;">
  <div class="panel__header">
    <h2>Inventario (Top 10)</h2>
    <a href="/autos" class="btn btn--primary d-inline-flex d-md-none">Ver inventario completo</a>
  </div>

  <% if (!inventory || inventory.length === 0) { %>
    <p class="empty">No hay autos en inventario.</p>
  <% } else { %>
    <div class="table-wrapper" style="overflow-x:auto;">
      <table class="inventory-table" style="width:100%; border-collapse:collapse; min-width:980px;">
        <thead>
          <tr style="background:#f7f8fa;">
            <th style="text-align:left; padding:.55rem .8rem;">Auto</th>
            <th style="text-align:left; padding:.55rem .8rem;">A√±o</th>
            <th style="text-align:left; padding:.55rem .8rem;">Precio/d√≠a</th>
            <th style="text-align:left; padding:.55rem .8rem;">Estatus</th>
            <th style="text-align:left; padding:.55rem .8rem;"># Reservas</th>
            <th style="text-align:left; padding:.55rem .8rem;">Alta</th>
          </tr>
        </thead>
        <tbody>
          <% inventory.forEach(car => { 
            const s = (car.status || 'available').toLowerCase();
            const pillClass =
              s === 'sold' ? 'invpill-sold' :
              (s === 'reserved' ? 'invpill-reserved' :
              (s === 'publicado' || s === 'available') ? 'invpill-available' : 'invpill-secondary');
          %>
            <tr style="border-bottom:1px solid #eef0f2;">
              <td style="padding:.55rem .8rem; display:flex; align-items:center; gap:.6rem;">
                <img
                  src="<%= car.image_url && car.image_url !== '' ? car.image_url : '/Assets/Imgs/placeholder-car.jpg' %>"
                  alt=""
                  style="width:52px; height:36px; object-fit:cover; border-radius:.35rem; box-shadow:0 4px 12px rgba(0,0,0,.06);"
                />
                <div>
                  <div style="font-weight:600;"><%= car.brand %> <%= car.model %></div>
                  <div style="font-size:.75rem; color:#64748b;">ID #<%= car.id %></div>
                </div>
              </td>
              <td style="padding:.55rem .8rem;"><%= car.year %></td>
              <td style="padding:.55rem .8rem;">$<%= Number(car.price_per_day || 0).toLocaleString('es-MX') %></td>
              <td style="padding:.55rem .8rem;">
                <span class="invpill <%= pillClass %>" style="display:inline-block;padding:.25rem .6rem;border-radius:999px;font-size:.7rem;text-transform:capitalize;">
                  <%= s %>
                </span>
              </td>
              <td style="padding:.55rem .8rem;"><%= car.reservas_total %></td>
              <td style="padding:.55rem .8rem;"><%= fechaBonita(car.created_at) %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  <% } %>
</section>


    </main>

    <script>
      const adminBtn = document.getElementById('adminSidebarToggle');
      const adminSidebar = document.getElementById('adminSidebar');

      if (adminBtn && adminSidebar) {
        adminBtn.addEventListener('click', () => {
          adminSidebar.classList.toggle('is-open');
        });
      }
    </script>
  </body>
</html>

