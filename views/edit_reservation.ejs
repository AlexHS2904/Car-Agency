<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Reprogramar reserva</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/Assets/styles.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
      body { background: #0f1214; }
      .page-wrap { background: #f5f6f8; min-height: 100vh; padding-top: 100px; }
      .car-card {
        background: #fff;
        border-radius: 1.5rem;
        overflow: hidden;
        box-shadow: 0 10px 35px rgba(15,15,15,.08);
      }
      .car-card img { 
        width: 100%; 
        height: 180px; 
        object-fit: cover; 
      }

      .btn-link{
        color: red;
      }
    </style>
  </head>
  <body>
    <%- include("partials/header.ejs") %>

    <div class="page-wrap">
      <div class="container">
        <div class="row g-4">
          <div class="col-md-4">
            <div class="car-card mb-4">
              <img src="<%= car.image_url && car.image_url !== '' ? car.image_url : '/Assets/Imgs/placeholder-car.jpg' %>" alt="">
              <div class="p-3">
                <h5 class="mb-1"><%= car.brand %> <%= car.model %></h5>
                <p class="mb-1 text-muted">$<%= Number(car.price_per_day).toLocaleString('es-MX') %> MXN/día</p>
                <div class="alert alert-info mb-0">
                  Estás reprogramando esta reserva.
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-8">
            <div class="bg-white rounded-4 p-4 shadow-sm">
              <h4 class="mb-3">Reprogramar reserva</h4>

              <% if (errors && errors.length > 0) { %>
                <div class="alert alert-danger">
                  <ul class="mb-0">
                    <% errors.forEach(e => { %>
                      <li><%= e %></li>
                    <% }) %>
                  </ul>
                </div>
              <% } %>

              <form action="/reservas/<%= reserva.id %>/editar" method="POST">
                <div class="mb-3">
                  <label class="form-label">Nuevo rango de fechas</label>
                  <input
                    type="text"
                    class="form-control"
                    id="dateRange"
                    name="dateRange"
                    placeholder="Selecciona las fechas"
                    required
                    value=""
                  >
                  <div class="form-text">Las fechas ya ocupadas están bloqueadas.</div>
                </div>

                <button type="submit" class="btn btn-outline-dark">
                  Guardar cambios
                </button>
                <a href="/reservations" class="btn btn-link">Volver</a>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- pasamos las reservas de este auto para bloquear -->
    <script id="reservations-data" type="application/json">
      <%- JSON.stringify(reservations || []) %>
    </script>

    <script>
      const booked = JSON.parse(document.getElementById("reservations-data").textContent || "[]");
      const disabled = booked.map(r => ({
        from: r.start_date,
        to: r.end_date
      }));

      // iniciamos flatpickr
      flatpickr("#dateRange", {
        mode: "range",
        dateFormat: "Y-m-d",
        minDate: "today",
        disable: disabled,
      });
    </script>
  </body>
</html>
